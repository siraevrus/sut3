# Документация базы данных - Система складского учета

## Обзор структуры

База данных спроектирована для поддержки полного цикла складских операций с учетом ролевой модели доступа и настраиваемых характеристик товаров.

## Основные таблицы

### 1. Организационная структура

#### `companies` - Компании
- Хранит информацию о компаниях-клиентах
- Включает полные реквизиты для документооборота
- Поддерживает архивирование (status = -1)

#### `warehouses` - Склады
- Привязаны к компаниям
- Каждый склад имеет уникальное название и адрес
- Поддерживает деактивацию

#### `users` - Пользователи системы
- 4 роли: admin, pc_operator, warehouse_worker, sales_manager
- Администратор не привязан к компании/складу
- Остальные роли привязаны к конкретным складам
- Поддерживает блокировку пользователей

### 2. Система товаров

#### `product_templates` - Шаблоны товаров
- Создаются только администратором
- Содержат формулы для автоматического расчета
- Основа для создания товарных позиций

#### `template_attributes` - Характеристики шаблонов
- Настраиваемые поля для каждого шаблона
- Поддержка разных типов данных (число, текст, выпадающий список)
- Флаги для участия в формулах и обязательности

#### `products` - Товары
- Конкретные товарные позиции на складах
- JSON поле для хранения значений характеристик
- Автоматический расчет объема по формулам

#### `inventory` - Остатки
- Текущие остатки товаров на складах
- Поддержка резервирования товаров
- Денормализация для производительности

### 3. Операционные таблицы

#### `requests` - Запросы
- Запросы от сотрудников на товары
- JSON хранение запрашиваемых характеристик
- Статусы: pending, processed

#### `goods_in_transit` - Товары в пути
- Отслеживание транспортировки товаров
- Прикрепление файлов (накладные, фото)
- Статусы: in_transit, arrived, confirmed

#### `sales` - Реализация
- Продажи товаров со складов
- Поддержка разных типов оплаты (наличная/безналичная)
- Автоматическое списание с остатков

#### `warehouse_operations` - Журнал операций
- Логирование всех операций со складом
- Аудит изменений остатков
- Связь с исходными операциями

### 4. Системные таблицы

#### `user_sessions` - Сессии пользователей
- Управление активными сессиями
- Время жизни 30 дней
- Отслеживание IP и User Agent

#### `system_settings` - Настройки системы
- Конфигурационные параметры
- Аудит изменений настроек

## Представления (Views)

### `v_inventory_details`
Детальная информация об остатках с объединением данных из связанных таблиц:
- Название шаблона товара
- Информация о складе и компании
- Характеристики товара
- Доступное количество (с учетом резерва)

### `v_active_requests`
Активные (необработанные) запросы с информацией о создателях:
- Данные пользователя, создавшего запрос
- Название шаблона товара
- Информация о компании сотрудника

### `v_dashboard_stats`
Статистика для дашборда администратора:
- Количество активных компаний
- Количество активных пользователей
- Количество необработанных запросов
- Количество товаров в пути
- Сумма продаж за сегодня

## Индексы

Созданы индексы для оптимизации частых запросов:
- По статусам записей
- По датам операций
- По связям между таблицами
- По полям поиска и фильтрации

## Ограничения целостности

- Внешние ключи обеспечивают целостность связей
- Каскадное удаление для зависимых записей
- Уникальные ключи для предотвращения дублирования

## Типы данных

### JSON поля
- `products.attributes` - характеристики товара
- `requests.requested_attributes` - запрашиваемые характеристики
- `goods_in_transit.goods_info` - информация о грузе
- `goods_in_transit.files` - прикрепленные файлы
- `template_attributes.options` - варианты для выпадающих списков

### ENUM поля
- `users.role` - роли пользователей
- `requests.status` - статусы запросов
- `goods_in_transit.status` - статусы доставки
- `warehouse_operations.operation_type` - типы операций
- `template_attributes.data_type` - типы данных характеристик

## Безопасность

- Пароли хешируются с использованием bcrypt
- Сессии имеют ограниченное время жизни
- Мягкое удаление для критичных данных
- Аудит операций через warehouse_operations

## Производительность

- Денормализация в таблице inventory для быстрых запросов остатков
- Индексы на часто используемые поля
- Представления для сложных запросов
- JSON индексы для поиска по характеристикам (MySQL 5.7+)

## Масштабирование

База данных спроектирована для поддержки:
- До 1000 активных шаблонов товаров
- До 1,000,000 товарных записей
- До 10 одновременных пользователей
- До 100 транзакций в день

## Резервное копирование

Рекомендуется создавать резервные копии:
- Ежедневно - полная копия
- Каждые 4 часа - инкрементальная копия
- Хранить копии минимум 30 дней

## Миграции

При изменении структуры БД:
1. Создать файл миграции в папке `sql/migrations/`
2. Обновить версию в `system_settings`
3. Протестировать на копии продакшн данных
4. Выполнить в режиме обслуживания